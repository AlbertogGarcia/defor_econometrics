---
title: "final_outline"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
# plots
source('did_trends.R')

#binary fcns
source('quickmonte.R')
source('TWFE_fcn.R')
source('DID_keep.R')
source('functionalform.R')
source('functionalform_agg.R')

source('outcome_fcn.R')
source('aggregation_fcn.R')
source('aggregate_complete.R') #aggreagate_complete is the function we'll use most in this outline, as it runs all combinations and generates summary dataframe to be used for specification chart
source('layerprocess_fcn.R')

source('vary_outcome_defor.R')
source('vary_outcome_yr.R')
source('vary_rate_funcform.R')
source('vary_rate_funcform_agg.R')

source('landscape_map.R')

```


```{r generating landscape parameters, results='hide'}

base_0 = .02
base_1 = .05
trend = -.005
ATT = -.01

std_a = 0.1
std_v = 0.25
years = 3
nobs = 10000
n = 250

cellsize = 10
ppoints = 70
std_p = 0
cpoints = 40


```

```{r}

# generate landscape plot

# grids still need to be added to the landscape- will fix soon
landscape_map <- landscape_map(nobs, years, b0, b1, b2, b3, std_a = 0.1, std_v = 0.25, std_p = 0.1, cellsize, ppoints, cpoints)$landscape_period2_counter


```


```{r aggregate, results = 'hide', warning=FALSE}
std_p = 0
std_a = 0.1
# we'll need to recompute the parameters if we change the value of sigma_p
std_avp = (std_a^2+std_v^2+std_p^2)^.5
b0 = qnorm(base_0, mean = 0, sd = std_avp)
b1 = qnorm(base_1, mean = 0, sd = std_avp) - b0
b2_0 = qnorm(trend + base_0, mean = 0, sd = std_avp) - b0
b2_1 = qnorm(trend + base_1, mean = 0, sd = std_avp) - b0 - b1
b3 = qnorm( pnorm(b0+b1+b2_1, mean = 0, sd = std_avp) + ATT , mean = 0, sd = std_avp) - (b0 + b1 + b2_1)

# summary function that estimates all of the different specifications
aggregation <- aggregate_complete(n, nobs, years, b0, b1, b2_0, b2_1, b3, std_a, std_v, std_p, cellsize, ppoints, cpoints, rm.selection = TRUE)

summary_long <- aggregation$summary_long

# summary function that estimates all of the different specifications
aggregation_sel <- aggregate_complete(250, nobs, years, b0, b1, b2_0, b2_1, b3, std_a, std_v, std_p, cellsize, ppoints, cpoints, rm.selection = FALSE)

summary_selection <- aggregation_sel$summary_long %>%
  mutate(iteration = as.integer(iteration))%>%
  inner_join(aggregation_sel$selection_bias, by = "iteration")

export(summary_selection, "summary_selection.rds")


```


```{r aggregate sig_p 1, results = 'hide', warning=FALSE}
std_p = 0.1
std_avp = (std_a^2+std_v^2+std_p^2)^.5
b0 = qnorm(base_0, mean = 0, sd = std_avp)
b1 = qnorm(base_1, mean = 0, sd = std_avp) - b0
b2_0 = qnorm(trend + base_0, mean = 0, sd = std_avp) - b0
b2_1 = qnorm(trend + base_1, mean = 0, sd = std_avp) - b0 - b1
b3 = qnorm( pnorm(b0+b1+b2_1, mean = 0, sd = std_avp) + ATT , mean = 0, sd = std_avp) - (b0 + b1 + b2_1)

aggregation_1 <- aggregate_complete(n, nobs, years, b0, b1, b2_0, b2_1, b3, std_a, std_v, std_p, cellsize, ppoints, cpoints, rm.selection = TRUE)

summary_long_1 <- aggregation_1$summary_long

```

```{r aggregate sig_p 2, results = 'hide', warning=FALSE}
std_p = 0.2
std_avp = (std_a^2+std_v^2+std_p^2)^.5
b0 = qnorm(base_0, mean = 0, sd = std_avp)
b1 = qnorm(base_1, mean = 0, sd = std_avp) - b0
b2_0 = qnorm(trend + base_0, mean = 0, sd = std_avp) - b0
b2_1 = qnorm(trend + base_1, mean = 0, sd = std_avp) - b0 - b1
b3 = qnorm( pnorm(b0+b1+b2_1, mean = 0, sd = std_avp) + ATT , mean = 0, sd = std_avp) - (b0 + b1 + b2_1)

aggregation_2 <- aggregate_complete(n, nobs, years, b0, b1, b2_0, b2_1, b3, std_a, std_v, std_p, cellsize, ppoints, cpoints, rm.selection = TRUE)

summary_long_2 <- aggregation_2$summary_long


```

```{r aggregate sig_p 3, results = 'hide', warning=FALSE}

std_p = 0.3
std_avp = (std_a^2+std_v^2+std_p^2)^.5
b0 = qnorm(base_0, mean = 0, sd = std_avp)
b1 = qnorm(base_1, mean = 0, sd = std_avp) - b0
b2_0 = qnorm(trend + base_0, mean = 0, sd = std_avp) - b0
b2_1 = qnorm(trend + base_1, mean = 0, sd = std_avp) - b0 - b1
b3 = qnorm( pnorm(b0+b1+b2_1, mean = 0, sd = std_avp) + ATT , mean = 0, sd = std_avp) - (b0 + b1 + b2_1)

aggregation_3 <- aggregate_complete(n, nobs, years, b0, b1, b2_0, b2_1, b3, std_a, std_v, std_p, cellsize, ppoints, cpoints, rm.selection = TRUE)

summary_long_3 <- aggregation_3$summary_long

summary_full <- rbind(summary_long, summary_long_1, summary_long_2, summary_long_3)
library(rio)
export(summary_full, "summary_full.rds")


summary_full <- readRDS("unbiased_dgp/summary_full.rds")

full_summary <- summary_full %>%
  mutate_at(vars(bias, cover), as.numeric
  )%>%
  mutate_at(vars(pixel, grid, property, county, pixel.fe, grid.fe, property.fe, county.fe, treatment.fe, weights, se_pixel, se_grid, se_property, se_county), ~ as.logical(as.integer(.))
  )%>%
  filter(is.na(notes) & pixel.fe == FALSE)%>%
  group_by(std_p, pixel, grid, property, county, pixel.fe, grid.fe, property.fe, county.fe, treatment.fe, weights, se_pixel, se_grid, se_property, se_county)%>%
  summarise(cover = mean(cover))%>%
  spread(std_p, cover)



did_cover <- full_summary %>%
  filter(pixel==TRUE & treatment.fe ==TRUE)%>%
  mutate(`unit of analysis` = "pixel",
         `fixed effects` = "treatment",
         se = ifelse(se_pixel, "clustered at pixel", ifelse(se_county, "clustered at county", ifelse(se_property, "clustered at property", ifelse(se_grid, "clustered at grid", NA))))
  )%>%
  subset( select=c(`unit of analysis`, `fixed effects`, se, `0`, `0.1`, `0.2`, `0.3`))

fix_cover <- full_summary %>%
  filter(pixel==TRUE & treatment.fe ==FALSE)%>%
  mutate(`unit of analysis` = "pixel",
         `fixed effects` = ifelse(county.fe, "county", ifelse(property.fe, "property", ifelse(grid.fe, "grid", NA))),
         se = ifelse(se_pixel, "clustered at pixel", ifelse(se_county, "clustered at county", ifelse(se_property, "clustered at property", ifelse(se_grid, "clustered at grid", NA))))
  )%>%
  subset( select=c(`unit of analysis`, `fixed effects`, se, `0`, `0.1`, `0.2`, `0.3`))

agg_cover <- full_summary %>%
  filter(property==TRUE | county ==TRUE | grid == TRUE)%>%
  mutate(`unit of analysis` = ifelse(county, "county", ifelse(property, "property", ifelse(grid, "grid", NA))),
         `fixed effects` = ifelse(county.fe, "county", ifelse(property.fe, "property", ifelse(grid.fe, "grid", NA))),
         weighted = ifelse(weights, "yes", "no"),
         se = ifelse(se_pixel, "clustered at pixel", ifelse(se_county, "clustered at county", ifelse(se_property, "clustered at property", ifelse(se_grid, "clustered at grid", NA))))
  )%>%
  subset( select=c(`unit of analysis`, `fixed effects`, weighted, se, `0`, `0.1`, `0.2`, `0.3`))


write.csv(agg_cover, "agg_cover.csv")
write.csv(fix_cover, "fix_cover.csv")
write.csv(did_cover, "did_cover.csv")



```





```{r coverage}
did_coverage <- did_cover_0 %>%
  mutate(did_cover_1 = did_cover_1[,ncol(did_cover_1)],
         did_cover_2 = did_cover_2[,ncol(did_cover_2)],
         did_cover_3 = did_cover_3[,ncol(did_cover_3)]
         )

agg_coverage <- agg_cover_0 %>%
  mutate(agg_cover_1 = agg_cover_1[,ncol(agg_cover_1)],
         agg_cover_2 = agg_cover_2[,ncol(agg_cover_2)],
         agg_cover_3 = agg_cover_3[,ncol(agg_cover_3)]
         )
  
fe_coverage <-  fe_cover_0 %>%
  mutate(fe_cover_1 = fe_cover_1[,ncol(fe_cover_1)],
         fe_cover_2 = fe_cover_2[,ncol(fe_cover_2)],
         fe_cover_3 = fe_cover_3[,ncol(fe_cover_3)]
         ) 
  
# write.csv(did_coverage, "did_coverage.csv")  
# write.csv(agg_coverage, "agg_coverage.csv") 
# write.csv(fe_coverage, "fe_coverage.csv")  

```


```{r plot rmse, results = 'hide', warning=FALSE}


biases_p <- read.csv("bias_p.csv",check.names=FALSE,row.names = 1)[1:4,]

bias_plot_df <- biases_p %>%
  rownames_to_column(var = "unit of analysis") %>%
  melt(variable.name = "sigma_p", value.name = "bias" )%>%
  filter(`unit of analysis` !="pixel")

mytheme <- theme(#axis.line = element_line(size = 1, colour = "black"),
                 panel.grid.major  = element_line(colour="grey", size=rel(0.5)),
                 panel.grid.minor = element_blank(),
                 panel.background = element_rect(fill="whitesmoke"),
                 plot.title= element_text(hjust = 0.5))

cbPalette <- c("pixel (DID)" = "#E69F00", county = "#56B4E9", grid = "#009E73", property ="#D55E00")#, "#CC79A7",  "#0072B2")

plot_bias = ggplot(data = bias_plot_df, aes(x = as.numeric(as.character(sigma_p)), y = bias, colour = `unit of analysis`)) +
  ylim(-.005, .0005)+
    geom_line(size = 1) +
  geom_segment(aes(x=0, xend=.3, y=0, yend=0), linetype = "dashed", size=.25, color="black")+
  geom_vline(xintercept = 0, size=.25)+
    #theme(plot.caption = element_text(hjust = 0.5))+
    labs(y = "coefficient bias", x= expression(sigma[p]), colour = "unit of analysis")+
  ggtitle(expression(paste("coefficient bias vs. ", sigma[p], " by unit of analysis")))+
   #theme_classic() +
  #scale_colour_manual(values=cbPalette)+
  theme_minimal()+
  theme(plot.title= element_text(hjust = 0.5))
plot_bias

ggsave(path = "figs", filename = "bias_uoa.png", dpi = 500)

```

```{r plot fe rmse, results = 'hide', warning=FALSE}



fe_biases_p <- read.csv("fe_bias_p.csv",check.names=FALSE,row.names = 1)

did_plot_df <- biases_p %>%
  rownames_to_column(var = "fe") %>%
  filter(fe=="pixel")%>%
  mutate(fe = "treatment")

fe_bias_plot_df <- fe_biases_p %>%
  rownames_to_column(var = "fe") %>%
  bind_rows(did_plot_df)%>%
  melt(variable.name = "sigma_p", value.name = "bias" )%>%
  separate(fe, into = c("fixed effects", "uoa"), sep = " ")

fe_plot_bias = ggplot(data = fe_bias_plot_df, aes(x = as.numeric(as.character(sigma_p)), y = bias, colour = `fixed effects`)) +
  ylim(-.005, .0005)+
    geom_line(size = 1) +
  geom_segment(aes(x=0, xend=.3, y=0, yend=0), linetype = "dashed", size=.25, color="black")+
  geom_vline(xintercept = 0, size=.25)+
    #theme(plot.caption = element_text(hjust = 0.5))+
    labs(y = "coefficient bias", x= expression(sigma[p]), colour = "fixed effects")+
  ggtitle(expression(paste("coefficient bias vs. ", sigma[p], " by fixed effects level")))+
 theme_minimal() +
  theme(plot.title= element_text(hjust = 0.5))
  #scale_colour_manual(values=cbPalette)
  # mytheme
fe_plot_bias

ggsave(path = "figs", filename = "bias_fe.png", dpi = 500)

```

```{r}

full_summary <- rbind(summary0_df, summary1_df, summary2_df, summary3_df)


