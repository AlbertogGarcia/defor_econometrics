---
title: Spatially aggregated fixed effects not effective when unit is not fully treated
author: "Alberto Garcia and Robert Heilmayr"
date: "April 20th, 2022"
output:
  bookdown::pdf_document2:
    latex_engine: xelatex
    number_sections: yes
    toc: no
  html_document: default
  documentclass: article
#bibliography: deforestation_econometrics.bib
header-includes: 
  \usepackage{bbm}  
  \usepackage{graphicx}
  \usepackage{amsmath}
  \usepackage{amssymb}
  \usepackage{sectsty}
  \usepackage{mathtools}
  \usepackage{float}
---

\sectionfont{\fontsize{11}{11}\selectfont}
\subsectionfont{\fontsize{11}{11}\selectfont}


```{r setup, include=FALSE}
library(knitr)
library(ggplot2)
library(kableExtra)
library(tidyverse)



knitr::opts_chunk$set(echo = FALSE, warnings = FALSE, messages = FALSE, out.width="49%", fig.align = "center", fig.pos = 'H')
```

<!-- To do: -->

<!-- - outcome: binary outcome equal to one if any deforestation occurs within boundary -->
<!-- - adjust bias plot to spec chart  -->
<!-- - multiple group-period extension -->

<!-- Possible extensions: -->
<!-- - weighting possibilities -->
<!-- make properties more or less heterogeneous -->



# Two-way fixed effects with spatially aggregated fixed effects

We will consider three variations of TWFE regressions in two separate instances: when the spatially aggregated unit has 1) binary treatment (i.e., all pixels within the unit are either treated or untreated); and 2) continuous treatment. 

Let $D_i$ represent a dummy indicating whether pixel $i$ is ever treated and $\mathbb{1} \{ t\geq t_0\}$ represent an indicator equal to 1 in the periods after treatment has ocurred. The three candidate specifications are as follows:

\textbf{Regression 1:} (Binary treatment indicator)
Let $\beta_{FE,j}$ denote the coefficient of the interaction between $D_{i}$ and $\mathbb{1} \{ t\geq t_0\}$  in the following (population) OLS regression:
\begin{align}
y^o_{it} = \alpha + \beta_{FE} \text{ x } D_i \mathbb{1} \{ t\geq t_0\} + \lambda_t + \gamma_p + \epsilon_{it}
\end{align}
, where $\lambda_t$ denotes year fixed effects and $\gamma_p$ fixed effects at the level of the spatially aggregated unit (i.e., property)

\textbf{Regression 2:} (Binary + treat)
Let $\beta_{FE,j}$ denote the coefficient of the interaction between $D_{i}$ and $\mathbb{1} \{ t\geq t_0\}$  in the following (population) OLS regression:
\begin{align}
y^o_{it} = \alpha_0 + \beta_{TFE} \text{ x } D_i \mathbb{1} \{ t\geq t_0\} + \alpha_1 D_i + \lambda_t + \gamma_p + \epsilon_{it}
\end{align}
Regression 2 is similar to regression 1 with the exception of the addition of the treatment group indicator, $D_i$. 

\textbf{Regression 3:} (Continuous treatment)
Let $\beta_{FE,j}$ denote the coefficient of the interaction between $D_{i}$ and $\mathbb{1} \{ t\geq t_0\}$  in the following (population) OLS regression:
\begin{align}
y^o_{it} = \alpha + \beta_{C} \text{ x } D_p \mathbb{1} \{ t\geq t_0\} + \lambda_t + \gamma_p + \epsilon_{it}
\end{align}
Note that in these regressions, the level of unit fixed effects matches the unit of analysis. The treatment variable $D_p = \frac{1}{N_p}\sum_{i=1}^{N_p}D_p$, is the average treatment value amongst all pixels in unit $p$.


We now explore specifications utilizing the property as the spatially aggregated unit. 

## When treatment is assigned at the property level

In this case, all pixels within any given property will be in either the treatment or control group. This means that the treatment is binary at the property level. Here, all specifications are equivalent to Regression 1. In Regression 2, $D_i$ is washed out by the unit fixed effects. In Regression 3, $D_p = 1$ or 0, simplifying to the binary case. The results of 100 iterations on our simulated landscape, assigning treatment at the property level and setting $\sigma_p = 0$ and $0.5$ are as follows. 


```{r prop, fig.pos='h'}
results <- readRDS("propFE_explore.rds")%>%
  filter(assignment != "county" & std_p == 0)%>%
  select( treatment.var, Bias, std_p)

kable(results, format = "latex", row.names = TRUE,  booktabs = T,
      caption = "comparison of specification when treatment is assigned at property level (binary property treatment)",
      col.names = c("Regression", "Bias", "$\\sigma_p$"), escape = FALSE
       ) %>%
  kable_styling(font_size = 10, latex_options = c("HOLD_position", "striped"),
                position = "center")%>%
  row_spec(3, hline_after = FALSE)

```

## When treatment is assigned at the county level

Now, the three $\beta$s are not equivalent. In fact, the coefficient of interest from Regression 1 is nowhere near recovering the $ATT$  with or without property level unobservables. 

Regressions 2 and 3 are much better, however, there are reasons why each would not be preferred. Regression 2 is essentially the traditional DID with the addition of properrty fixed effects, but there is no clear extension to the case of multiple groups. Regression 3 gives up information regarding the treatment status of each pixel in order to use the treatment proportion of the aggregated unit, which makes little sense. 

The next step is to understand why specification 1 performs so poorly. 


```{r county}
results <- readRDS("propFE_explore.rds")%>%
  filter(assignment == "county"& std_p == 0)%>%
  select( treatment.var, Bias, std_p)

kable(results, format = "latex", row.names = TRUE,  booktabs = T,
      caption = "comparison of specification when treatment is assigned at property level (binary property treatment)",
      col.names = c("Regression", "Bias", "$\\sigma_p$"), escape = FALSE
       ) %>%
  kable_styling(font_size = 10, latex_options = c("HOLD_position", "striped"),
                position = "center")%>%
  row_spec(3, hline_after = FALSE)


```

## No informative changes with $\sigma_p$ = 0.5

```{r std-5, fig.pos = "H"}
results <- readRDS("propFE_explore.rds")%>%
  filter(std_p == .5)%>%
  select(treatment.var, Bias, std_p, assignment)

kable(results, format = "latex", row.names = TRUE,  booktabs = T,
      caption = "comparison of specification when treatment is assigned at property level (binary property treatment)",
      col.names = c("Regression", "Bias", "$\\sigma_p$", "treatment assignment"), escape = FALSE
       ) %>%
  kable_styling(font_size = 10, latex_options = c("HOLD_position", "striped"),
                position = "center")%>%
  row_spec(3, hline_after = TRUE)


```



